{% extends 'base.html' %}

{% block title %}{{ project.name }} - Code RAG{% endblock %}

{% block sidebar %}
    <div style="margin-top: 16px;">
        <p style="font-size: 12px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">Chat History</p>
        {% for session in sessions %}
            <a href="{% url 'chat_session' session.id %}" style="text-decoration: none;">
                <div class="project-item">
                    <div class="project-name">{{ session.title|truncatewords:5 }}</div>
                    <div class="project-meta">{{ session.chat_messages.count }} messages</div>
                </div>
            </a>
        {% endfor %}
    </div>
{% endblock %}

{% block header_title %}
    <div>
        <a href="{% url 'index' %}" style="color: var(--text-secondary); text-decoration: none; font-size: 13px;">‚Üê Projects</a>
        <div style="margin-top: 4px;">{{ project.name }}</div>
    </div>
{% endblock %}

{% block header_actions %}
    <button class="btn btn-secondary" onclick="reindexProject()">üîÑ Reindex</button>
    <button class="btn btn-secondary" style="background: #c23b22; margin-left: 8px;" onclick="deleteProjectFromDetail()">üóëÔ∏è Delete Project</button>
{% endblock %}

{% block content %}
<div style="max-width: 1000px;">
    <div style="background: var(--bg-light); border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border);">
        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">Project Overview</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Total Files</div>
                <div style="font-size: 24px; font-weight: 600; color: var(--primary);">{{ project.total_files }}</div>
            </div>
            <div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Chat Sessions</div>
                <div style="font-size: 24px; font-weight: 600; color: var(--primary);">{{ sessions|length }}</div>
            </div>
            <div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Last Indexed</div>
                <div style="font-size: 14px;">{{ project.last_indexed|date:'M d, H:i' }}</div>
            </div>
        </div>

        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
            <div style="margin-bottom: 8px;"><strong>Folder:</strong> {{ project.folder_path }}</div>
            <div><strong>Description:</strong> {{ project.description|default:"No description" }}</div>
        </div>
    </div>

    {% if project.files.all %}
        <div style="background: var(--bg-light); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
            <h2 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Indexed Files ({{ project.files.count }})</h2>
            
            <div style="display: grid; gap: 8px; max-height: 400px; overflow-y: auto;">
                {% for file in project.files.all|slice:':20' %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-dark); border-radius: 4px; border-left: 3px solid var(--primary);">
                        <div>
                            <div style="font-size: 13px; font-weight: 500;">{{ file.file_name }}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">{{ file.chunk_count }} chunks ‚Ä¢ {{ file.file_size|filesizeformat }}</div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">{{ file.file_type }}</div>
                    </div>
                {% endfor %}
                {% if project.files.count > 20 %}
                    <div style="text-align: center; padding: 12px; color: var(--text-secondary); font-size: 12px;">
                        +{{ project.files.count|add:'-20' }} more files
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<script>
function deleteProjectFromDetail() {
    const projectName = '{{ project.name }}';
    if (confirm(`Are you sure you want to delete "${projectName}"?\n\nThis will delete the project and all associated chat sessions and data. This action cannot be undone.`)) {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥ Deleting...';

        fetch('/api/projects/{{ project.id }}/delete_project/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Project deleted successfully!');
                window.location.href = '{% url "index" %}';
            } else if (data.error) {
                alert('Error: ' + data.error);
                btn.disabled = false;
                btn.textContent = 'üóëÔ∏è Delete Project';
            }
        })
        .catch(error => {
            alert('Error deleting project: ' + error);
            btn.disabled = false;
            btn.textContent = 'üóëÔ∏è Delete Project';
        });
    }
}

function reindexProject() {
    if (!confirm('This will re-scan and index all project files. Continue?')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'üîÑ Reindexing...';

    fetch('/api/projects/{{ project.id }}/reindex_files/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.total_files !== undefined) {
            alert('Reindexing complete! Found ' + data.total_files + ' files.');
            window.location.reload();
        } else {
            alert('Error: ' + JSON.stringify(data));
        }
    })
    .catch(error => alert('Error: ' + error))
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'üîÑ Reindex';
    });
}
</script>
{% endblock %}
